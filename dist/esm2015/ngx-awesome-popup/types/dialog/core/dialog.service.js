import { ApplicationRef, ComponentFactoryResolver, Injectable, Injector } from '@angular/core';
import { DialogClass } from './model';
import { DialogInjector } from '../../../core/dialog-injector';
import { map } from 'rxjs/operators';
import { DialogWrapperComponent } from '../dialog-wrapper/dialog-wrapper.component';
import * as i0 from "@angular/core";
export class DialogService {
    constructor(componentFactoryResolver, injector, appRef) {
        this.componentFactoryResolver = componentFactoryResolver;
        this.injector = injector;
        this.appRef = appRef;
        this.dialogParentComponentRefList = [];
    }
    open(_ComponentType, _DialogBelonging) {
        const dialogController = _DialogBelonging.EventsController;
        const componentRef = this.getComponentRef(dialogController, _DialogBelonging);
        this.dialogParentComponentRefList.push(componentRef);
        componentRef.instance.dialogBelonging = _DialogBelonging;
        componentRef.instance.childComponentType = _ComponentType;
        this.appendToBodyParentComponent(componentRef);
        this.listeners(dialogController);
        return dialogController;
    }
    getComponentRef(_EventsController, _DialogBelonging) {
        let componentFactory;
        const dialogIndex = this.findDialogIndex(_DialogBelonging.EntityUniqueID);
        if (dialogIndex === -1) {
            const weakMap = new WeakMap();
            weakMap.set(DialogClass.DialogEventsController, _EventsController);
            componentFactory = this.componentFactoryResolver.resolveComponentFactory(DialogWrapperComponent);
            return componentFactory.create(new DialogInjector(this.injector, weakMap));
        }
        return null;
    }
    listeners(_EventsController) {
        // Listener for closing dialog
        const closeDialogSubscription = _EventsController.afterClosed$.subscribe((response) => {
            const modalIndex = this.findDialogIndex(response.DialogBelonging.EntityUniqueID);
            this.removeFromBodyDialogWrapperComponent(modalIndex);
            closeDialogSubscription.unsubscribe();
        });
        // Listener for turning off loader
        const closeLoaderSubscription = _EventsController.afterLoader$.subscribe((_DialogUniqueID) => {
            if (_DialogUniqueID) {
                const modalIndex = this.findDialogIndex(_DialogUniqueID);
                if (modalIndex !== -1) {
                    this.dialogParentComponentRefList[modalIndex].instance.closeLoader();
                }
            }
            closeLoaderSubscription.unsubscribe();
        });
    }
    childComponentResolver() {
    }
    appendToBodyParentComponent(_ComponentRef) {
        // attach view to ignite lifecycle hooks
        this.appRef.attachView(_ComponentRef.hostView);
        // DOM
        const domElem = _ComponentRef.hostView.rootNodes[0];
        document.body.appendChild(domElem);
    }
    closeDialogWrapperComponent(_DialogUniqueID) {
        const modalIndex = this.findDialogIndex(_DialogUniqueID);
        this.removeFromBodyDialogWrapperComponent(modalIndex);
    }
    removeFromBodyDialogWrapperComponent(_DialogIndex) {
        if (_DialogIndex > -1) {
            this.dialogParentComponentRefList[_DialogIndex].instance.closeParent$('close-fast').pipe(map(item => {
                this.appRef.detachView(this.dialogParentComponentRefList[_DialogIndex].hostView);
                this.dialogParentComponentRefList[_DialogIndex].destroy();
                this.dialogParentComponentRefList.splice(_DialogIndex, 1);
            })).subscribe();
        }
    }
    findDialogIndex(_DialogUniqueID) {
        return this.dialogParentComponentRefList.findIndex((item) => {
            return _DialogUniqueID === item.instance.dialogBelonging.EntityUniqueID;
        });
    }
}
DialogService.ɵprov = i0.ɵɵdefineInjectable({ factory: function DialogService_Factory() { return new DialogService(i0.ɵɵinject(i0.ComponentFactoryResolver), i0.ɵɵinject(i0.INJECTOR), i0.ɵɵinject(i0.ApplicationRef)); }, token: DialogService, providedIn: "root" });
DialogService.decorators = [
    { type: Injectable, args: [{
                providedIn: 'root'
            },] }
];
DialogService.ctorParameters = () => [
    { type: ComponentFactoryResolver },
    { type: Injector },
    { type: ApplicationRef }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9uZ3gtYXdlc29tZS1wb3B1cC90eXBlcy9kaWFsb2cvY29yZS9kaWFsb2cuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsY0FBYyxFQUFFLHdCQUF3QixFQUFpQyxVQUFVLEVBQUUsUUFBUSxFQUFPLE1BQU0sZUFBZSxDQUFDO0FBQ2xJLE9BQU8sRUFBQyxXQUFXLEVBQWtCLE1BQU0sU0FBUyxDQUFDO0FBQ3JELE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSwrQkFBK0IsQ0FBQztBQUM3RCxPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkMsT0FBTyxFQUFDLHNCQUFzQixFQUFDLE1BQU0sNENBQTRDLENBQUM7O0FBS2xGLE1BQU0sT0FBTyxhQUFhO0lBSXRCLFlBQW9CLHdCQUFrRCxFQUFVLFFBQWtCLEVBQVUsTUFBc0I7UUFBOUcsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQUFVLGFBQVEsR0FBUixRQUFRLENBQVU7UUFBVSxXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUZsSSxpQ0FBNEIsR0FBd0IsRUFBRSxDQUFDO0lBR3ZELENBQUM7SUFFRCxJQUFJLENBQUMsY0FBeUIsRUFBRSxnQkFBNkM7UUFDekUsTUFBTSxnQkFBZ0IsR0FBRyxnQkFBZ0IsQ0FBQyxnQkFBZ0IsQ0FBQztRQUMzRCxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFFOUUsSUFBSSxDQUFDLDRCQUE0QixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNyRCxZQUFZLENBQUMsUUFBUSxDQUFDLGVBQWUsR0FBTSxnQkFBZ0IsQ0FBQztRQUM1RCxZQUFZLENBQUMsUUFBUSxDQUFDLGtCQUFrQixHQUFHLGNBQWMsQ0FBQztRQUUx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QUFVLENBQUMsSUFBSSxDQUFDLDRCQUE0QixDQUFDLFlBQVksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNqRixJQUFJLENBQUMsNEJBQTRCLENBQUMsWUFBWSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQzFELElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzlELENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDbkI7SUFDTCxDQUFDO0lBRUQsZUFBZSxDQUFDLGVBQXVCO1FBQ25DLE9BQU8sSUFBSSxDQUFDLDRCQUE0QixDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3hELE9BQU8sZUFBZSxLQUFLLElBQUksQ0FBQyxRQUFRLENBQUMsZUFBZSxDQUFDLGNBQWMsQ0FBQztRQUM1RSxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7Ozs7WUFwR0osVUFBVSxTQUFDO2dCQUNSLFVBQVUsRUFBRSxNQUFNO2FBQ3JCOzs7WUFSdUIsd0JBQXdCO1lBQTZDLFFBQVE7WUFBN0YsY0FBYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7QXBwbGljYXRpb25SZWYsIENvbXBvbmVudEZhY3RvcnlSZXNvbHZlciwgQ29tcG9uZW50UmVmLCBFbWJlZGRlZFZpZXdSZWYsIEluamVjdGFibGUsIEluamVjdG9yLCBUeXBlfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7RGlhbG9nQ2xhc3MsIERpYWxvZ0ludGVyZmFjZX0gZnJvbSAnLi9tb2RlbCc7XG5pbXBvcnQge0RpYWxvZ0luamVjdG9yfSBmcm9tICcuLi8uLi8uLi9jb3JlL2RpYWxvZy1pbmplY3Rvcic7XG5pbXBvcnQge21hcH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHtEaWFsb2dXcmFwcGVyQ29tcG9uZW50fSBmcm9tICcuLi9kaWFsb2ctd3JhcHBlci9kaWFsb2ctd3JhcHBlci5jb21wb25lbnQnO1xuXG5ASW5qZWN0YWJsZSh7XG4gICAgcHJvdmlkZWRJbjogJ3Jvb3QnXG59KVxuZXhwb3J0IGNsYXNzIERpYWxvZ1NlcnZpY2Uge1xuICAgIFxuICAgIGRpYWxvZ1BhcmVudENvbXBvbmVudFJlZkxpc3Q6IENvbXBvbmVudFJlZjxhbnk+W10gPSBbXTtcbiAgICBcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbXBvbmVudEZhY3RvcnlSZXNvbHZlcjogQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBwcml2YXRlIGluamVjdG9yOiBJbmplY3RvciwgcHJpdmF0ZSBhcHBSZWY6IEFwcGxpY2F0aW9uUmVmKSB7XG4gICAgfVxuICAgIFxuICAgIG9wZW4oX0NvbXBvbmVudFR5cGU6IFR5cGU8YW55PiwgX0RpYWxvZ0JlbG9uZ2luZzogRGlhbG9nQ2xhc3MuRGlhbG9nQmVsb25naW5nKTogRGlhbG9nSW50ZXJmYWNlLklEaWFsb2dFdmVudHNDb250cm9sbGVyIHtcbiAgICAgICAgY29uc3QgZGlhbG9nQ29udHJvbGxlciA9IF9EaWFsb2dCZWxvbmdpbmcuRXZlbnRzQ29udHJvbGxlcjtcbiAgICAgICAgY29uc3QgY29tcG9uZW50UmVmID0gdGhpcy5nZXRDb21wb25lbnRSZWYoZGlhbG9nQ29udHJvbGxlciwgX0RpYWxvZ0JlbG9uZ2luZyk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmRpYWxvZ1BhcmVudENvbXBvbmVudFJlZkxpc3QucHVzaChjb21wb25lbnRSZWYpO1xuICAgICAgICBjb21wb25lbnRSZWYuaW5zdGFuY2UuZGlhbG9nQmVsb25naW5nICAgID0gX0RpYWxvZ0JlbG9uZ2luZztcbiAgICAgICAgY29tcG9uZW50UmVmLmluc3RhbmNlLmNoaWxkQ29tcG9uZW50VHlwZSA9IF9Db21wb25lbnRUeXBlO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5hcHBlbmRUb0JvZHlQYXJlbnRDb21wb25lbnQoY29tcG9uZW50UmVmKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMubGlzdGVuZXJzKGRpYWxvZ0NvbnRyb2xsZXIpO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIGRpYWxvZ0NvbnRyb2xsZXI7XG4gICAgICAgIFxuICAgIH1cbiAgICBcbiAgICBnZXRDb21wb25lbnRSZWYoX0V2ZW50c0NvbnRyb2xsZXI6IERpYWxvZ0ludGVyZmFjZS5JRGlhbG9nRXZlbnRzQ29udHJvbGxlciwgX0RpYWxvZ0JlbG9uZ2luZzogRGlhbG9nQ2xhc3MuRGlhbG9nQmVsb25naW5nKTogQ29tcG9uZW50UmVmPGFueT4gfCBudWxsIHtcbiAgICAgICAgbGV0IGNvbXBvbmVudEZhY3Rvcnk7XG4gICAgICAgIFxuICAgICAgICBjb25zdCBkaWFsb2dJbmRleCA9IHRoaXMuZmluZERpYWxvZ0luZGV4KF9EaWFsb2dCZWxvbmdpbmcuRW50aXR5VW5pcXVlSUQpO1xuICAgICAgICBpZiAoZGlhbG9nSW5kZXggPT09IC0xKSB7XG4gICAgICAgICAgICBcbiAgICAgICAgICAgIGNvbnN0IHdlYWtNYXAgPSBuZXcgV2Vha01hcCgpO1xuICAgICAgICAgICAgd2Vha01hcC5zZXQoRGlhbG9nQ2xhc3MuRGlhbG9nRXZlbnRzQ29udHJvbGxlciwgX0V2ZW50c0NvbnRyb2xsZXIpO1xuICAgICAgICAgICAgXG4gICAgICAgICAgICBjb21wb25lbnRGYWN0b3J5ID0gdGhpcy5jb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIucmVzb2x2ZUNvbXBvbmVudEZhY3RvcnkoRGlhbG9nV3JhcHBlckNvbXBvbmVudCk7XG4gICAgICAgICAgICByZXR1cm4gY29tcG9uZW50RmFjdG9yeS5jcmVhdGUobmV3IERpYWxvZ0luamVjdG9yKHRoaXMuaW5qZWN0b3IsIHdlYWtNYXApKTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgXG4gICAgbGlzdGVuZXJzKF9FdmVudHNDb250cm9sbGVyOiBEaWFsb2dJbnRlcmZhY2UuSURpYWxvZ0V2ZW50c0NvbnRyb2xsZXIpIHtcbiAgICAgICAgXG4gICAgICAgIC8vIExpc3RlbmVyIGZvciBjbG9zaW5nIGRpYWxvZ1xuICAgICAgICBjb25zdCBjbG9zZURpYWxvZ1N1YnNjcmlwdGlvbiA9IF9FdmVudHNDb250cm9sbGVyLmFmdGVyQ2xvc2VkJC5zdWJzY3JpYmUoKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICBjb25zdCBtb2RhbEluZGV4ID0gdGhpcy5maW5kRGlhbG9nSW5kZXgocmVzcG9uc2UuRGlhbG9nQmVsb25naW5nLkVudGl0eVVuaXF1ZUlEKTtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRnJvbUJvZHlEaWFsb2dXcmFwcGVyQ29tcG9uZW50KG1vZGFsSW5kZXgpO1xuICAgICAgICAgICAgY2xvc2VEaWFsb2dTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAvLyBMaXN0ZW5lciBmb3IgdHVybmluZyBvZmYgbG9hZGVyXG4gICAgICAgIGNvbnN0IGNsb3NlTG9hZGVyU3Vic2NyaXB0aW9uID0gX0V2ZW50c0NvbnRyb2xsZXIuYWZ0ZXJMb2FkZXIkLnN1YnNjcmliZSgoX0RpYWxvZ1VuaXF1ZUlEOiBzdHJpbmcpID0+IHtcbiAgICAgICAgICAgIGlmIChfRGlhbG9nVW5pcXVlSUQpIHtcbiAgICAgICAgICAgICAgICBjb25zdCBtb2RhbEluZGV4ID0gdGhpcy5maW5kRGlhbG9nSW5kZXgoX0RpYWxvZ1VuaXF1ZUlEKTtcbiAgICAgICAgICAgICAgICBpZiAobW9kYWxJbmRleCAhPT0gLTEpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5kaWFsb2dQYXJlbnRDb21wb25lbnRSZWZMaXN0W21vZGFsSW5kZXhdLmluc3RhbmNlLmNsb3NlTG9hZGVyKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgXG4gICAgICAgICAgICBjbG9zZUxvYWRlclN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGNoaWxkQ29tcG9uZW50UmVzb2x2ZXIoKSB7XG4gICAgXG4gICAgfVxuICAgIFxuICAgIGFwcGVuZFRvQm9keVBhcmVudENvbXBvbmVudChfQ29tcG9uZW50UmVmOiBDb21wb25lbnRSZWY8YW55Pik6IHZvaWQge1xuICAgICAgICBcbiAgICAgICAgLy8gYXR0YWNoIHZpZXcgdG8gaWduaXRlIGxpZmVjeWNsZSBob29rc1xuICAgICAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KF9Db21wb25lbnRSZWYuaG9zdFZpZXcpO1xuICAgICAgICBcbiAgICAgICAgLy8gRE9NXG4gICAgICAgIGNvbnN0IGRvbUVsZW0gPSAoX0NvbXBvbmVudFJlZi5ob3N0VmlldyBhcyBFbWJlZGRlZFZpZXdSZWY8YW55Pikucm9vdE5vZGVzWzBdIGFzIEhUTUxFbGVtZW50O1xuICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGRvbUVsZW0pO1xuICAgICAgICBcbiAgICB9XG4gICAgXG4gICAgY2xvc2VEaWFsb2dXcmFwcGVyQ29tcG9uZW50KF9EaWFsb2dVbmlxdWVJRDogc3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IG1vZGFsSW5kZXggPSB0aGlzLmZpbmREaWFsb2dJbmRleChfRGlhbG9nVW5pcXVlSUQpO1xuICAgICAgICB0aGlzLnJlbW92ZUZyb21Cb2R5RGlhbG9nV3JhcHBlckNvbXBvbmVudChtb2RhbEluZGV4KTtcbiAgICB9XG4gICAgXG4gICAgcmVtb3ZlRnJvbUJvZHlEaWFsb2dXcmFwcGVyQ29tcG9uZW50KF9EaWFsb2dJbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgICAgIGlmIChfRGlhbG9nSW5kZXggPiAtMSkge1xuICAgICAgICAgICAgdGhpcy5kaWFsb2dQYXJlbnRDb21wb25lbnRSZWZMaXN0W19EaWFsb2dJbmRleF0uaW5zdGFuY2UuY2xvc2VQYXJlbnQkKCdjbG9zZS1mYXN0JykucGlwZShtYXAoaXRlbSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hcHBSZWYuZGV0YWNoVmlldyh0aGlzLmRpYWxvZ1BhcmVudENvbXBvbmVudFJlZkxpc3RbX0RpYWxvZ0luZGV4XS5ob3N0Vmlldyk7XG4gICAgICAgICAgICAgICAgdGhpcy5kaWFsb2dQYXJlbnRDb21wb25lbnRSZWZMaXN0W19EaWFsb2dJbmRleF0uZGVzdHJveSgpO1xuICAgICAgICAgICAgICAgIHRoaXMuZGlhbG9nUGFyZW50Q29tcG9uZW50UmVmTGlzdC5zcGxpY2UoX0RpYWxvZ0luZGV4LCAxKTtcbiAgICAgICAgICAgIH0pKS5zdWJzY3JpYmUoKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBmaW5kRGlhbG9nSW5kZXgoX0RpYWxvZ1VuaXF1ZUlEOiBzdHJpbmcpOiBudW1iZXIge1xuICAgICAgICByZXR1cm4gdGhpcy5kaWFsb2dQYXJlbnRDb21wb25lbnRSZWZMaXN0LmZpbmRJbmRleCgoaXRlbSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIF9EaWFsb2dVbmlxdWVJRCA9PT0gaXRlbS5pbnN0YW5jZS5kaWFsb2dCZWxvbmdpbmcuRW50aXR5VW5pcXVlSUQ7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cbiJdfQ==